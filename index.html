<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Hex grid — Дмитров с фильтром</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Turf.js -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
html, body, #map { height: 100%; margin: 0; padding: 0; }

.hex-label-svg text {
    font-weight: bold;
    fill: #000;
    text-shadow: 0 0 2px #fff;
    font-size: 12px;
}

/* Панель фильтров */
#filterPanel {
    position: absolute;
    top: 50px;
    left: 15px;
    background: #fff;
    padding: 12px 16px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 1000;
    font-family: sans-serif;
    min-width: 180px;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

#filterPanel.hidden {
    transform: translateX(-220px);
    opacity: 0;
}

/* Кнопка открытия панели */
#toggleFilter {
    position: absolute;
    top: 10px;
    left: 15px;
    z-index: 1001;
    background: #5b21b6;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

#toggleFilter:hover {
    background: #7c3aed;
}

/* Элементы панели */
#filterPanel h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #5b21b6;
}

#filterPanel label {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
}

#filterPanel input[type="checkbox"] {
    margin-right: 8px;
    width: 16px;
    height: 16px;
}

#filterPanel input[type="number"] {
    width: 60px;
    padding: 3px 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    margin-left: 8px;
}

#filterPanel button {
    width: 100%;
    padding: 6px 0;
    background: #5b21b6;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

#filterPanel button:hover {
    background: #7c3aed;
}
</style>
</head>
<body>
<div id="map"></div>

<button id="toggleFilter">Фильтры</button>

<div id="filterPanel">
    <h3>Фильтры</h3>
    <label>
        <input type="checkbox" id="hideYellow" /> Скрыть жёлтые
    </label>
    <label>
        Порог цены:
        <input type="number" id="priceThreshold" value="0" />
    </label>
    <button id="applyFilter">Применить</button>
</div>

<script>
const dmitrovCenter = [56.344326, 37.543373];
const centerLngLat = [dmitrovCenter[1], dmitrovCenter[0]];
const basePrice = 127;

const map = L.map('map').setView(dmitrovCenter, 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

const radiusKm = 3.2;
const hexSizeKm = 0.2;

let hexCenters = [];
let hexPolygons = [];
let hexLayers = [];
let markers = [];
let offersData = [];

// Генерация сетки
async function generateGrid() {
    const circle = turf.circle(centerLngLat, radiusKm, { steps: 128, units: 'kilometers' });
    const bbox = turf.bbox(circle);
    let grid = turf.hexGrid(bbox, hexSizeKm, { units: 'kilometers' });
    grid.features = grid.features.filter(f => turf.booleanIntersects(f, circle));

    hexCenters = grid.features.map(f => {
        const c = turf.centerOfMass(f).geometry.coordinates;
        return { lon: c[0], lat: c[1] };
    });
    hexPolygons = grid.features;

    L.geoJSON(circle, { style:{color:'#444',weight:1,fill:false,dashArray:'4 6'} }).addTo(map);

    await addTextToHexes();
}

// Добавление текста и цветных шестиугольников
async function addTextToHexes() {
    try {
        const res = await fetch('/offers');
        offersData = await res.json();

        offersData.forEach(offer => {
            let nearestIndex = hexCenters.reduce((bestIndex, curr, i, arr) => {
                const dPrev = turf.distance([offer.lon, offer.lat], [arr[bestIndex].lon, arr[bestIndex].lat]);
                const dCurr = turf.distance([offer.lon, offer.lat], [curr.lon, curr.lat]);
                return dCurr < dPrev ? i : bestIndex;
            }, 0);

            const hexFeature = hexPolygons[nearestIndex];
            const diff = Math.abs(offer.price - basePrice);

            let fillColor;
            let fillOpacity = 0.7; // дефолтная непрозрачность
            let isYellow = false;

            if (diff < 250) {
                fillColor = '#facc15';
                fillOpacity = 0.4; // прозрачность, чтобы видеть карту
                isYellow = true;
            } else {
                const maxDiff = 500;
                const t = Math.min(diff / maxDiff, 1);
                const r = Math.round(167 - 167 * t);
                const g = Math.round(139 - 139 * t);
                const b = Math.round(250 - 250 * t);
                fillColor = `rgb(${r},${g},${b})`;
                fillOpacity = 0.7; // фиолетовые остаются плотными
            }

            const hexLayer = L.geoJSON(hexFeature, {
                style:{color:'#5b21b6', weight:1, fillColor: fillColor, fillOpacity: fillOpacity}
            }).addTo(map);

            const svg = `<svg width="80" height="30">
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">${offer.price}</text>
                         </svg>`;

            const marker = L.marker([hexCenters[nearestIndex].lat, hexCenters[nearestIndex].lon], {
                icon: L.divIcon({
                    className: 'hex-label-svg',
                    html: svg,
                    iconSize: [80, 30],
                    iconAnchor: [40, 15]
                }),
                interactive: false
            }).addTo(map);

            hexLayers.push({layer: hexLayer, isYellow, price: offer.price});
            markers.push({marker, isYellow, price: offer.price});
        });

    } catch(err) {
        console.error('Ошибка получения офферов:', err);
    }
}

// Фильтры
function applyFilter() {
    const hideYellow = document.getElementById('hideYellow').checked;
    const priceThreshold = parseFloat(document.getElementById('priceThreshold').value) || 0;

    hexLayers.forEach(h => {
        if ((hideYellow && h.isYellow) || (h.price < priceThreshold)) {
            map.removeLayer(h.layer);
        } else {
            map.addLayer(h.layer);
        }
    });

    markers.forEach(m => {
        if ((hideYellow && m.isYellow) || (m.price < priceThreshold)) {
            map.removeLayer(m.marker);
        } else {
            map.addLayer(m.marker);
        }
    });
}

// Скрыть/показать панель
document.getElementById('toggleFilter').addEventListener('click', () => {
    const panel = document.getElementById('filterPanel');
    panel.classList.toggle('hidden');
});

document.getElementById('applyFilter').addEventListener('click', applyFilter);

generateGrid();
</script>
</body>
</html>
